package sunb.education.habbit.controller;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.bind.annotation.*;import sunb.education.habbit.components.Rule;import sunb.education.habbit.components.RuleResult;import sunb.education.habbit.repository.RuleRepository;import sunb.education.habbit.repository.RuleResultRepository;import java.util.ArrayList;import java.util.List;/** * Created with IntelliJ IDEA. * Description: * Project Name:    habbit * User:            sunb * Date:            2017-11-29 * Time:            18:39 */@RestController@RequestMapping("api")public class RuleResultController {    @Autowired    RuleResultRepository resultRepository;    @Autowired    RuleRepository ruleRepository;    @PostMapping("results")    @Transactional    public List<RuleResult> results(@RequestBody List<RuleResult> results) {        List<Rule> collect = new ArrayList<>(results.size());        String date = null;        for (RuleResult result : results) {            date = result.getCheckDate();            if (result.getId() == null) {                Rule rule = result.getRule();                int newScore = result.getDidIt() ? Math.max(0, rule.getScore() - 10) : rule.getScore() + 10;                rule.setScore(newScore);                collect.add(rule);            }        }        ruleRepository.save(collect);        if (date != null) {            resultRepository.deleteRuleResultByCheckDate(date);        }        List<RuleResult> saved = resultRepository.save(results);        return saved;    }    @GetMapping("hints")    public List<RuleResult> hints(@RequestParam String date) {        List<RuleResult> ruleResultByCheckDate = resultRepository.findRuleResultByCheckDate(date);        return ruleResultByCheckDate;    }}